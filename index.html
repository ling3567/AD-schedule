<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部長行程協調小幫手 (雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // --- 圖示組件 ---
        const Icon = ({ path, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            User: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6"></polyline>} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"></polyline>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Ban: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></>} />,
            CornerDownRight: (p) => <Icon {...p} path={<><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></>} />,
            Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />
        };

        const { useState, useEffect } = React;

        const MinisterScheduleApp = () => {
            const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem('minister_gs_url') || '');
            const [urlInput, setUrlInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            
            // Data
            const [slots, setSlots] = useState([]);
            const [requests, setRequests] = useState([]);
            
            // UI
            const [activeTab, setActiveTab] = useState('calendar');
            const [showAddSlot, setShowAddSlot] = useState(false);
            const [showAddRequest, setShowAddRequest] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());

            // Forms
            const [newSlot, setNewSlot] = useState({ date: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' });
            const [newRequest, setNewRequest] = useState({ title: '', slotId: '', requestorNote: '', requestorName: '依玲', startTime: '', endTime: '' });

            // API Helper
            const callApi = async (action, payload = {}, showLoading = true) => {
                if (!scriptUrl) return;
                if (showLoading) setIsLoading(true);
                try {
                    // Using no-cors might be needed but GAS usually handles POSTs well if text/plain
                    // For simplicity in this demo, we use POST with stringified body
                    const response = await fetch(scriptUrl + '?action=' + action, {
                        method: 'POST', 
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (data.status === 'error') throw new Error(data.message);
                    return data;
                } catch (err) {
                    console.error(err);
                    setError('連線失敗，請檢查網址或網路: ' + err.message);
                } finally {
                    if (showLoading) setIsLoading(false);
                }
            };

            const refreshData = async () => {
                const data = await callApi('read');
                if (data) {
                    setSlots(data.slots || []);
                    setRequests(data.requests || []);
                    setError('');
                }
            };

            // Init Load
            useEffect(() => {
                if (scriptUrl) refreshData();
            }, [scriptUrl]);

            // Handlers
            const handleSaveUrl = () => {
                if(!urlInput.includes('script.google.com')) { alert('網址格式看起來不對喔'); return; }
                localStorage.setItem('minister_gs_url', urlInput);
                setScriptUrl(urlInput);
                setShowSettings(false);
            };

            const handleAddSlot = async (e) => {
                e.preventDefault();
                const tempId = Date.now();
                const slotData = { ...newSlot, id: tempId };
                await callApi('addSlot', slotData);
                await refreshData(); // Reload to sync
                setNewSlot({ date: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' });
                setShowAddSlot(false);
            };

            const handleDeleteSlot = async (id) => {
                if (!confirm('確定刪除此時段？將一併刪除該時段下所有會議。')) return;
                await callApi('deleteSlot', { id });
                refreshData();
            };

            const isTimeOverlapping = (slotId, start, end) => {
                const existingRequests = requests.filter(r => r.slotId === slotId);
                return existingRequests.some(req => start < req.endTime && end > req.startTime);
            };

            const handleAddRequest = async (e) => {
                e.preventDefault();
                if (isTimeOverlapping(parseInt(newRequest.slotId), newRequest.startTime, newRequest.endTime)) {
                    alert('無法新增：此時段與現有會議時間重疊！'); return;
                }
                const reqData = { ...newRequest, id: Date.now(), slotId: parseInt(newRequest.slotId), step: 1, updatedAt: new Date().toISOString() };
                await callApi('addRequest', reqData);
                await refreshData();
                setNewRequest({ title: '', slotId: '', requestorNote: '', requestorName: '依玲', startTime: '', endTime: '' });
                setShowAddRequest(false);
                setActiveTab('dashboard');
            };

            const handleUpdateStep = async (reqId, newStep) => {
                // Optimistic update
                setRequests(prev => prev.map(r => r.id === reqId ? { ...r, step: newStep, updatedAt: new Date().toISOString() } : r));
                await callApi('updateRequestStep', { id: reqId, step: newStep, updatedAt: new Date().toISOString() }, false);
            };

            const handleDeleteRequest = async (id) => {
                if (!confirm('確定取消此會議安排？')) return;
                await callApi('deleteRequest', { id });
                refreshData();
            };

            // Setup Screen
            if (!scriptUrl || showSettings) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                            <h1 className="text-2xl font-bold mb-4 text-center text-slate-800">首次設定</h1>
                            <p className="text-sm text-gray-600 mb-4">請貼上您的 Google Apps Script 網頁應用程式網址：</p>
                            <input type="text" placeholder="https://script.google.com/..." className="w-full p-3 border border-gray-300 rounded mb-4" value={urlInput} onChange={e => setUrlInput(e.target.value)} />
                            <button onClick={handleSaveUrl} className="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">開始使用</button>
                            {scriptUrl && <button onClick={() => setShowSettings(false)} className="w-full mt-2 text-gray-500 text-sm underline">取消</button>}
                            <div className="mt-6 text-xs text-gray-400 border-t pt-4">
                                <p>如何取得網址？</p>
                                <ol className="list-decimal pl-4 mt-1 space-y-1">
                                    <li>建立 Google 試算表</li>
                                    <li>擴充功能 &gt; Apps Script</li>
                                    <li>貼上後端程式碼並儲存</li>
                                    <li>部署 &gt; 新增部署 &gt; 網頁應用程式 &gt; 權限設為「所有人」</li>
                                    <li>複製產生的網址貼上至此</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Helpers for Render ---
            const STEPS = {
                1: { label: '待確認', color: 'bg-gray-100 text-gray-700', icon: <Icons.User size={14}/> },
                2: { label: '回報伊君', color: 'bg-blue-100 text-blue-700', icon: <Icons.Clock size={14}/> },
                3: { label: '確認中', color: 'bg-purple-100 text-purple-700', icon: <Icons.AlertCircle size={14}/> },
                4: { label: '已完成', color: 'bg-emerald-600 text-white', icon: <Icons.CheckCircle size={14}/> },
            };
            const WEEKDAYS = ['日', '一', '二', '三', '四', '五', '六'];
            const HOURS = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
            const MINUTES = ['00', '15', '30', '45'];
            const TimeSelect = ({ value, onChange, className }) => {
                const [h, m] = value ? value.split(':') : ['09', '00'];
                return (<div className={`flex items-center gap-1 ${className}`}><select value={h} onChange={(e) => onChange(`${e.target.value}:${m}`)} className="p-2 border rounded bg-white flex-1 min-w-[60px]">{HOURS.map(x=><option key={x} value={x}>{x}</option>)}</select>:<select value={m} onChange={(e) => onChange(`${h}:${e.target.value}`)} className="p-2 border rounded bg-white flex-1 min-w-[60px]">{MINUTES.map(x=><option key={x} value={x}>{x}</option>)}</select></div>);
            };
            const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
            const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
            const getSlotDisplay = (id) => { const s = slots.find(x => x.id == id); return s ? `${s.date} ${s.startTime}-${s.endTime}` : '未知'; };
            const getRequestsBySlotId = (id) => requests.filter(r => r.slotId == id);
            const getAvailableSlots = () => slots.filter(s => s.type === 'available');

            return (
                <div className="min-h-screen flex flex-col max-w-5xl mx-auto bg-white shadow-xl">
                    <header className="bg-slate-800 text-white p-4 sticky top-0 z-20 flex justify-between items-center shadow-md">
                        <div><h1 className="text-xl font-bold flex items-center gap-2"><Icons.Calendar size={24} /> 部長行程協調 (Google Sheet版)</h1></div>
                        <div className="flex items-center gap-3">
                            {isLoading && <div className="loader"></div>}
                            <button onClick={() => refreshData()} className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white transition-colors">重新整理</button>
                            <button onClick={() => setShowSettings(true)} className="text-slate-400 hover:text-white"><Icons.Settings size={20}/></button>
                            <button onClick={() => setShowAddSlot(true)} className="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-1"><Icons.Plus size={16} /> <span className="hidden sm:inline">記時段</span></button>
                        </div>
                    </header>
                    
                    {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert"><p>{error}</p></div>}

                    <div className="p-2 sm:p-4 flex-1 bg-gray-50">
                        {/* Tabs */}
                        <div className="flex gap-2 mb-4 border-b border-gray-200 overflow-x-auto bg-white p-2 rounded-t-lg">
                            {['calendar', 'dashboard', 'slots'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 font-medium flex items-center gap-2 whitespace-nowrap transition-colors rounded-lg ${activeTab === tab ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}>
                                    {tab === 'calendar' && <><Icons.Calendar size={18}/> 月曆</>}
                                    {tab === 'dashboard' && <><Icons.List size={18}/> 追蹤 ({requests.filter(r => r.step < 4).length})</>}
                                    {tab === 'slots' && <><Icons.Clock size={18}/> 列表</>}
                                </button>
                            ))}
                        </div>

                        {/* Modals */}
                        {showAddSlot && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full animate-fade-in-down">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2">新增時段</h3>
                                    <form onSubmit={handleAddSlot} className="space-y-4">
                                        <div className="flex bg-gray-100 p-1 rounded-lg">
                                            <button type="button" onClick={() => setNewSlot({...newSlot, type: 'available'})} className={`flex-1 py-2 rounded font-bold flex gap-2 justify-center ${newSlot.type === 'available' ? 'bg-white text-emerald-600 shadow' : 'text-gray-500'}`}><Icons.CheckCircle size={16}/> 有空</button>
                                            <button type="button" onClick={() => setNewSlot({...newSlot, type: 'occupied'})} className={`flex-1 py-2 rounded font-bold flex gap-2 justify-center ${newSlot.type === 'occupied' ? 'bg-white text-gray-600 shadow' : 'text-gray-500'}`}><Icons.Ban size={16}/> 已佔用</button>
                                        </div>
                                        <div><label className="text-sm font-bold text-gray-600">日期</label><input type="date" required className="w-full p-2 border rounded" value={newSlot.date} onChange={e => setNewSlot({...newSlot, date: e.target.value})}/></div>
                                        <div className="flex gap-2"><div className="flex-1"><label className="text-sm font-bold text-gray-600">開始</label><TimeSelect value={newSlot.startTime} onChange={v => setNewSlot({...newSlot, startTime: v})} /></div><div className="flex-1"><label className="text-sm font-bold text-gray-600">結束</label><TimeSelect value={newSlot.endTime} onChange={v => setNewSlot({...newSlot, endTime: v})} /></div></div>
                                        <div><label className="text-sm font-bold text-gray-600">備註</label><input type="text" className="w-full p-2 border rounded" value={newSlot.note} onChange={e => setNewSlot({...newSlot, note: e.target.value})}/></div>
                                        <div className="flex gap-2"><button type="button" onClick={() => setShowAddSlot(false)} className="flex-1 py-2 bg-gray-100 rounded">取消</button><button type="submit" disabled={isLoading} className="flex-1 py-2 bg-emerald-600 text-white rounded">{isLoading?'儲存中...':'儲存'}</button></div>
                                    </form>
                                </div>
                            </div>
                        )}
                        
                        {/* Add Request Modal */}
                        {showAddRequest && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full animate-fade-in-down">
                                    <h3 className="font-bold text-lg mb-4">新增會議安排</h3>
                                    <form onSubmit={handleAddRequest} className="space-y-4">
                                        <div><label className="text-sm font-bold text-gray-600">選擇空檔</label><select className="w-full p-2 border rounded" value={newRequest.slotId} onChange={e=>{const s=slots.find(x=>x.id==e.target.value); if(s) setNewRequest({...newRequest, slotId: s.id, startTime:s.startTime, endTime:s.endTime});}} required><option value="">請選擇</option>{getAvailableSlots().map(s=><option key={s.id} value={s.id}>{s.date} {s.startTime}-{s.endTime}</option>)}</select></div>
                                        {newRequest.slotId && <div className="p-3 bg-gray-50 rounded border"><label className="text-xs font-bold text-gray-500 uppercase">會議時間</label><div className="flex gap-2 items-center"><TimeSelect value={newRequest.startTime} onChange={v=>setNewRequest({...newRequest, startTime:v})} className="flex-1"/><span className="text-gray-400">-</span><TimeSelect value={newRequest.endTime} onChange={v=>setNewRequest({...newRequest, endTime:v})} className="flex-1"/></div></div>}
                                        <div><label className="text-sm font-bold text-gray-600">預約人</label><input type="text" className="w-full p-2 border rounded" value={newRequest.requestorName} onChange={e => setNewRequest({...newRequest, requestorName: e.target.value})} required/></div>
                                        <div><label className="text-sm font-bold text-gray-600">事項</label><input type="text" className="w-full p-2 border rounded" value={newRequest.title} onChange={e => setNewRequest({...newRequest, title: e.target.value})} required/></div>
                                        <div><label className="text-sm font-bold text-gray-600">備註</label><input type="text" className="w-full p-2 border rounded" value={newRequest.requestorNote} onChange={e => setNewRequest({...newRequest, requestorNote: e.target.value})}/></div>
                                        <div className="flex gap-2"><button type="button" onClick={() => setShowAddRequest(false)} className="flex-1 py-2 bg-gray-100 rounded">取消</button><button type="submit" disabled={isLoading} className="flex-1 py-2 bg-blue-600 text-white rounded">{isLoading?'處理中...':'建立'}</button></div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Calendar View */}
                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                                <div className="flex justify-between items-center p-4 bg-gray-50 border-b">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:bg-gray-200 rounded-full"><Icons.ChevronLeft size={20}/></button>
                                    <h2 className="text-lg font-bold">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:bg-gray-200 rounded-full"><Icons.ChevronRight size={20}/></button>
                                </div>
                                <div className="grid grid-cols-7 border-b bg-gray-50">{WEEKDAYS.map(d => <div key={d} className="py-2 text-center text-xs font-bold text-gray-500">{d}</div>)}</div>
                                <div className="grid grid-cols-7 auto-rows-fr bg-white">
                                    {Array.from({ length: getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`e-${i}`} className="min-h-[100px] border-b border-r bg-gray-50/30"></div>)}
                                    {Array.from({ length: getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => {
                                        const day = i + 1;
                                        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                        const isToday = new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                                        const daySlots = slots.filter(s => s.date === dateStr).sort((a,b) => a.startTime.localeCompare(b.startTime));
                                        return (
                                            <div key={day} className={`min-h-[120px] border-b border-r p-1 relative hover:bg-slate-50 group ${isToday ? 'bg-amber-50' : ''}`}>
                                                <div className="flex justify-between mb-1"><span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday?'bg-amber-500 text-white':'text-gray-700'}`}>{day}</span>{daySlots.length===0 && <button onClick={()=>{setNewSlot({...newSlot, date: dateStr}); setShowAddSlot(true);}} className="hidden group-hover:block text-emerald-500"><Icons.Plus size={16}/></button>}</div>
                                                <div className="space-y-1">
                                                    {daySlots.map(slot => {
                                                        const reqs = getRequestsBySlotId(slot.id);
                                                        if(slot.type === 'occupied') return <div key={slot.id} className="text-[10px] p-1 bg-gray-100 text-gray-500 rounded border flex items-center gap-1"><Icons.Ban size={10}/> {slot.startTime}-{slot.endTime}</div>;
                                                        return (
                                                            <div key={slot.id} onClick={()=>{setNewRequest({...newRequest, slotId: slot.id, startTime: slot.startTime, endTime: slot.endTime}); setShowAddRequest(true);}} className="text-[10px] p-1 bg-emerald-50 border border-emerald-200 rounded cursor-pointer hover:bg-emerald-100">
                                                                <div className="font-bold text-emerald-700 flex justify-between"><span>{slot.startTime}-{slot.endTime}</span>{reqs.length===0 && <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>}</div>
                                                                {reqs.map(r => <div key={r.id} onClick={(e)=>{e.stopPropagation(); setActiveTab('dashboard');}} className={`mt-1 p-1 rounded border flex gap-1 ${r.step===4?'bg-emerald-600 text-white border-emerald-700':'bg-white text-blue-800 border-blue-200'}`}>{r.step===4?<Icons.CheckCircle size={10}/>:<Icons.CornerDownRight size={10}/>}<div className="truncate">{r.title}</div></div>)}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Dashboard View */}
                        {activeTab === 'dashboard' && (
                            <div className="grid gap-3">
                                <div className="flex justify-between items-center bg-blue-50 p-4 rounded border border-blue-100 mb-2"><div><h2 className="font-bold text-blue-900">會議看板</h2></div><button onClick={() => setShowAddRequest(true)} className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex gap-1"><Icons.Plus size={16}/> 新增</button></div>
                                {requests.sort((a,b)=>a.step===4?1:-1).map(req => (
                                    <div key={req.id} className={`bg-white rounded shadow-sm border p-3 relative ${req.step===4?'bg-emerald-50/50 border-emerald-100':''}`}>
                                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${STEPS[req.step].color.split(' ')[0]}`}></div>
                                        <div className="pl-3 flex flex-col sm:flex-row justify-between gap-3">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1"><span className={`text-[10px] px-2 py-0.5 rounded-full border flex items-center gap-1 ${STEPS[req.step].color}`}>{STEPS[req.step].icon} {STEPS[req.step].label}</span><span className="text-xs text-gray-400">{new Date(req.updatedAt).toLocaleDateString()}</span></div>
                                                <h3 className={`font-bold ${req.step===4?'text-emerald-800 line-through':''}`}>{req.title}</h3>
                                                <div className="text-xs text-gray-500 mt-1 flex items-center gap-2"><Icons.User size={12}/> {req.requestorName} <span className="text-gray-300">|</span> <Icons.Calendar size={12}/> {getSlotDisplay(req.slotId).split(' ')[0]} {req.startTime}-{req.endTime}</div>
                                                {req.requestorNote && <div className="text-xs text-gray-500 mt-1 bg-gray-50 p-1 rounded inline-block">備註: {req.requestorNote}</div>}
                                            </div>
                                            <div className="flex items-end gap-2">
                                                {req.step<4 ? <button onClick={()=>handleUpdateStep(req.id, req.step+1)} disabled={isLoading} className="bg-slate-800 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1">下一步 <Icons.ArrowRight size={12}/></button> : <span className="text-emerald-600 text-xs font-bold flex items-center gap-1"><Icons.CheckCircle size={12}/> 完成</span>}
                                                {req.step>1 && req.step<4 && <button onClick={()=>handleUpdateStep(req.id, req.step-1)} disabled={isLoading} className="text-gray-400 hover:text-gray-600 text-xs px-2">返回</button>}
                                                <button onClick={()=>handleDeleteRequest(req.id)} disabled={isLoading} className="text-gray-300 hover:text-red-500 p-1"><Icons.Trash2 size={16}/></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {requests.length===0 && <div className="text-center py-10 text-gray-400 border-2 border-dashed rounded">尚無會議安排</div>}
                            </div>
                        )}

                        {/* Slots List View */}
                        {activeTab === 'slots' && (
                             <div className="bg-white rounded shadow overflow-hidden">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-gray-50 border-b"><tr><th className="p-3">時間</th><th className="p-3">狀態</th><th className="p-3 text-right">操作</th></tr></thead>
                                    <tbody className="divide-y">
                                        {slots.sort((a,b)=>a.date.localeCompare(b.date)).map(slot=>(
                                            <tr key={slot.id} className="hover:bg-gray-50">
                                                <td className="p-3"><div>{slot.date}</div><div className="text-blue-600 font-mono">{slot.startTime}-{slot.endTime}</div><div className="text-xs text-gray-500">{slot.note}</div></td>
                                                <td className="p-3">{slot.type==='occupied'?<span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs">已佔用</span>:<span className="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-xs">有空</span>}</td>
                                                <td className="p-3 text-right"><button onClick={()=>handleDeleteSlot(slot.id)} className="text-gray-400 hover:text-red-500"><Icons.Trash2 size={16}/></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MinisterScheduleApp />);
    </script>
</body>
</html>
