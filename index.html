<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é•·è¡Œç¨‹é­”æ³•æ›¸ ğŸ°âœ¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: 'Quicksand', "Microsoft JhengHei", sans-serif; 
            background: linear-gradient(135deg, #fdf2f8 0%, #f0f9ff 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* é­”æ³•ç‰¹æ•ˆå‹•ç•« */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
        }
        @keyframes wand-wave {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }

        .animate-float { animation: float 8s ease-in-out infinite; }
        .animate-float-delay { animation: float 10s ease-in-out infinite 2s; }
        .animate-twinkle { animation: twinkle 4s ease-in-out infinite; }
        .animate-wand { animation: wand-wave 2s ease-in-out infinite; }

        .magic-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px -10px rgba(236, 72, 153, 0.15);
        }
        .magic-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .magic-btn:active { transform: scale(0.92); }
        
        /* å„ªåŒ–æ²è»¸æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(203, 213, 225, 0.5); border-radius: 20px; }
        
        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* Sticky Header for Groups */
        .sticky-group-header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
            background: rgba(240, 249, 255, 0.95);
        }
    </style>
</head>
<body class="text-slate-700 relative">
    
    <!-- èƒŒæ™¯è£é£¾ -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-[-20px] left-[-20px] text-pink-200 animate-float opacity-40"><svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor"><path d="M17.5,19c-5.02,0-9-2.02-9-4.5c0-0.61,0.24-1.19,0.67-1.72C9.07,12.6,9,12.41,9,12.21c0-2.95,3.66-5.41,8.38-5.69C17.75,3.88,18.81,2,20.5,2c2.48,0,4.5,4.03,4.5,9s-2.02,9-4.5,9c-0.27,0-0.53-0.05-0.79-0.14C19.16,19.57,18.36,19,17.5,19z M6,19c-3.31,0-6-2.69-6-6s2.69-6,6-6c0.59,0,1.15,0.09,1.69,0.25C8.38,4.72,10.94,3,14,3c0.17,0,0.34,0.01,0.5,0.02C13.23,6.86,9.91,10.66,9.91,15.2c0,0.6,0.07,1.18,0.19,1.74C9.17,18.12,7.67,19,6,19z"/></svg></div>
        <div class="absolute bottom-[-20px] right-[-20px] text-sky-100 animate-float-delay opacity-50"><svg width="300" height="180" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5,19C15.46,19,13,16.54,13,13.5S15.46,8,18.5,8s5.5,2.46,5.5,5.5S21.54,19,18.5,19z M6.5,19C3.46,19,1,16.54,1,13.5S3.46,8,6.5,8c0.47,0,0.92,0.06,1.36,0.17C7.32,7.16,7,6.12,7,5c0-2.76,2.24-5,5-5c2.56,0,4.67,1.92,4.96,4.41C17.37,4.15,17.92,4,18.5,4c3.04,0,5.5,2.46,5.5,5.5c0,0.17-0.01,0.33-0.03,0.5c0.64,1.01,1.03,2.21,1.03,3.5c0,3.59-2.91,6.5-6.5,6.5c-0.62,0-1.22-0.09-1.79-0.25C15.86,21.94,13.82,23,11.5,23c-3.04,0-5.5-2.46-5.5-5.5c0-0.49,0.07-0.97,0.19-1.42C5.69,16.68,5.12,17,4.5,17c-1.93,0-3.5-1.57-3.5-3.5s1.57-3.5,3.5-3.5c0.16,0,0.31,0.01,0.47,0.04C5.17,9.39,5.78,8.87,6.5,8.51V19z"/></svg></div>
        <div class="absolute top-32 right-4 md:right-10 text-yellow-300 animate-twinkle opacity-80"><svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2l3.09,6.26L22,9.27l-5,4.87l1.18,6.88L12,17.77l-6.18,3.25L7,14.14l-5-4.87l6.91-1.01L12,2z"/></svg></div>
        <div class="absolute bottom-32 left-4 md:left-10 text-purple-200 animate-twinkle opacity-80" style="animation-delay: 1.5s"><svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2l3.09,6.26L22,9.27l-5,4.87l1.18,6.88L12,17.77l-6.18,3.25L7,14.14l-5-4.87l6.91-1.01L12,2z"/></svg></div>
        <div class="absolute top-1/2 left-2 md:left-6 text-sky-200 animate-twinkle opacity-60" style="animation-delay: 0.5s"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2l3.09,6.26L22,9.27l-5,4.87l1.18,6.88L12,17.77l-6.18,3.25L7,14.14l-5-4.87l6.91-1.01L12,2z"/></svg></div>
        <div class="absolute bottom-10 right-1/4 text-pink-200 animate-twinkle opacity-50" style="animation-delay: 2.5s"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2l3.09,6.26L22,9.27l-5,4.87l1.18,6.88L12,17.77l-6.18,3.25L7,14.14l-5-4.87l6.91-1.01L12,2z"/></svg></div>
    </div>

    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        // --- åœ–ç¤ºçµ„ä»¶ ---
        const Icon = ({ path, size = 20, className = "", viewBox="0 0 24 24" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox={viewBox} fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            User: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6"></polyline>} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"></polyline>} />,
            ChevronDown: (p) => <Icon {...p} path={<polyline points="6 9 12 15 18 9"></polyline>} />,
            ChevronUp: (p) => <Icon {...p} path={<polyline points="18 15 12 9 6 15"></polyline>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Ban: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></>} />,
            CornerDownRight: (p) => <Icon {...p} path={<><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></>} />,
            Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />,
            Star: (p) => <Icon {...p} path={<><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></>} />,
            Archive: (p) => <Icon {...p} path={<><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></>} />,
            Fire: (p) => <Icon {...p} path={<><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.3.5.6.9.9z"></path></>} />,
            
            Castle: (p) => <Icon {...p} viewBox="0 0 24 24" path={<><path d="M2,22h20V10l-4-4v2h-2V6l-4-4L8,6v2H6v-2L2,10V22z M4,12h2v2H4V12z M4,16h2v2H4V16z M8,8h2v2H8V8z M8,12h2v2H8V12z M8,16h2v2H8V16z M14,8h2v2h-2V8z M14,12h2v2h-2V12z M14,16h2v2h-2V16z M18,12h2v2h-2V12z M18,16h2v2h-2V16z M10,22v-4h4v4H10z"/></>} />,
            Carriage: (p) => <Icon {...p} viewBox="0 0 24 24" path={<><circle cx="12" cy="13" r="8"></circle><circle cx="5.5" cy="20.5" r="2.5"></circle><circle cx="18.5" cy="20.5" r="2.5"></circle><path d="M12,5V2"></path><path d="M12,13h.01"></path><path d="M5.5,13H3"></path><path d="M18.5,13H21"></path></>} />,
            Wand: (p) => <Icon {...p} path={<><path d="M14.5,9.5L2,22"></path><path d="M17,7l2-4l2,4l4,2l-4,2l-2,4l-2-4l-4-2L17,7z"></path></>} />
        };
        
        // --- å…§å»ºç©©å®šç‰ˆå°ç£ç¯€æ—¥è³‡æ–™åº« (2024-2030) ---
        const getHolidayName = (dateStr) => {
            const d = new Date(dateStr);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const md = `${m}-${day}`;

            // 1. åœ‹æ›†å›ºå®šç¯€æ—¥
            if (md === '1-1') return 'å…ƒæ—¦';
            if (md === '2-28') return 'å’Œå¹³ç´€å¿µæ—¥';
            if (md === '5-1') return 'å‹å‹•ç¯€';
            if (md === '10-10') return 'åœ‹æ…¶æ—¥';

            // 2. å¹´åº¦ç‰¹å®šç¯€æ—¥ (å«è¾²æ›†å°ç…§èˆ‡è£œå‡)
            const yearHolidays = {
                2024: { '2-8': 'å°å¹´å¤œ', '2-9': 'é™¤å¤•', '2-10': 'æ˜¥ç¯€', '2-11': 'åˆäºŒ', '2-12': 'åˆä¸‰', '2-13': 'åˆå››', '2-14': 'åˆäº”', '4-4': 'å…’ç«¥ç¯€/æ¸…æ˜', '6-10': 'ç«¯åˆç¯€', '9-17': 'ä¸­ç§‹ç¯€' },
                2025: { '1-27': 'å°å¹´å¤œ', '1-28': 'é™¤å¤•', '1-29': 'æ˜¥ç¯€', '1-30': 'åˆäºŒ', '1-31': 'åˆä¸‰', '4-4': 'å…’ç«¥ç¯€/æ¸…æ˜', '5-31': 'ç«¯åˆç¯€', '10-6': 'ä¸­ç§‹ç¯€' },
                2026: { '1-1': 'å…ƒæ—¦', '2-16': 'å°å¹´å¤œ', '2-17': 'é™¤å¤•', '2-18': 'æ˜¥ç¯€', '2-19': 'åˆäºŒ', '2-20': 'åˆä¸‰', '2-27': 'å’Œå¹³ç´€å¿µæ—¥(è£œ)', '2-28': 'å’Œå¹³ç´€å¿µæ—¥', '4-3': 'å…’ç«¥ç¯€(è£œ)', '4-4': 'å…’ç«¥ç¯€', '4-5': 'æ¸…æ˜ç¯€', '4-6': 'æ¸…æ˜ç¯€(è£œ)', '5-1': 'å‹å‹•ç¯€', '6-19': 'ç«¯åˆç¯€', '9-25': 'ä¸­ç§‹ç¯€', '10-9': 'åœ‹æ…¶æ—¥(è£œ)', '10-10': 'åœ‹æ…¶æ—¥' },
                2027: { '1-1': 'å…ƒæ—¦', '2-5': 'é™¤å¤•', '2-6': 'æ˜¥ç¯€', '2-7': 'åˆäºŒ', '2-8': 'åˆä¸‰', '2-28': 'å’Œå¹³ç´€å¿µæ—¥', '4-4': 'å…’ç«¥ç¯€', '4-5': 'æ¸…æ˜ç¯€', '5-1': 'å‹å‹•ç¯€', '6-9': 'ç«¯åˆç¯€', '9-15': 'ä¸­ç§‹ç¯€', '10-10': 'åœ‹æ…¶æ—¥' },
                2028: { '1-1': 'å…ƒæ—¦', '1-25': 'é™¤å¤•', '1-26': 'æ˜¥ç¯€', '1-27': 'åˆäºŒ', '1-28': 'åˆä¸‰', '2-28': 'å’Œå¹³ç´€å¿µæ—¥', '4-4': 'å…’ç«¥ç¯€/æ¸…æ˜', '5-1': 'å‹å‹•ç¯€', '5-28': 'ç«¯åˆç¯€', '10-3': 'ä¸­ç§‹ç¯€', '10-10': 'åœ‹æ…¶æ—¥' },
                2029: { '1-1': 'å…ƒæ—¦', '2-12': 'é™¤å¤•', '2-13': 'æ˜¥ç¯€', '2-14': 'åˆäºŒ', '2-15': 'åˆä¸‰', '2-28': 'å’Œå¹³ç´€å¿µæ—¥', '4-4': 'å…’ç«¥ç¯€/æ¸…æ˜', '5-1': 'å‹å‹•ç¯€', '6-16': 'ç«¯åˆç¯€', '9-22': 'ä¸­ç§‹ç¯€', '10-10': 'åœ‹æ…¶æ—¥' },
                2030: { '1-1': 'å…ƒæ—¦', '2-2': 'é™¤å¤•', '2-3': 'æ˜¥ç¯€', '2-4': 'åˆäºŒ', '2-5': 'åˆä¸‰', '2-28': 'å’Œå¹³ç´€å¿µæ—¥', '4-5': 'å…’ç«¥ç¯€/æ¸…æ˜', '5-1': 'å‹å‹•ç¯€', '6-5': 'ç«¯åˆç¯€', '9-12': 'ä¸­ç§‹ç¯€', '10-10': 'åœ‹æ…¶æ—¥' }
            };

            if (yearHolidays[y] && yearHolidays[y][md]) {
                return yearHolidays[y][md];
            }
            
            return null;
        };

        const { useState, useEffect } = React;

        const MinisterScheduleApp = () => {
            const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem('minister_gs_url') || '');
            const [urlInput, setUrlInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            
            // Data
            const [slots, setSlots] = useState([]);
            const [requests, setRequests] = useState([]);
            
            // UI
            const [activeTab, setActiveTab] = useState('calendar');
            const [dashboardTab, setDashboardTab] = useState('active'); 
            const [showAddSlot, setShowAddSlot] = useState(false);
            const [showAddRequest, setShowAddRequest] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            // Editing State
            const [editingSlotId, setEditingSlotId] = useState(null);
            
            // Grouping State
            const [collapsedMonths, setCollapsedMonths] = useState({});
            const [historyCollapsedMonths, setHistoryCollapsedMonths] = useState({});

            // Forms
            const [newSlot, setNewSlot] = useState({ startDate: '', endDate: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' });
            const [newRequest, setNewRequest] = useState({ title: '', slotId: '', requestorNote: '', requestorName: 'ä¾ç²', startTime: '', endTime: '' });

            // --- Normalization ---
            const normalizeData = (list) => {
                if (!Array.isArray(list)) return [];
                return list.map(item => {
                    let newItem = { ...item };
                    if (newItem.date) {
                        try {
                            const d = new Date(newItem.date);
                            if (!isNaN(d.getTime())) {
                                const taipeiDate = d.toLocaleDateString('sv-SE', { timeZone: 'Asia/Taipei' });
                                newItem.date = taipeiDate;
                            } else if (typeof newItem.date === 'string' && newItem.date.includes('T')) {
                                newItem.date = newItem.date.split('T')[0];
                            }
                        } catch (e) { console.error("Date parse error", e); }
                    }
                    const fixTime = (t) => {
                        if (!t) return '';
                        if (typeof t === 'string' && t.includes('T') && t.includes('Z')) {
                            const d = new Date(t);
                            if (!isNaN(d.getTime())) {
                                return d.toLocaleTimeString('sv-SE', { timeZone: 'Asia/Taipei', hour: '2-digit', minute: '2-digit' });
                            }
                        }
                        let str = String(t);
                        if (str.includes(':') && str.length >= 5) {
                            return str.substring(0, 5);
                        }
                        return str;
                    };
                    if (newItem.startTime) newItem.startTime = fixTime(newItem.startTime);
                    if (newItem.endTime) newItem.endTime = fixTime(newItem.endTime);
                    return newItem;
                });
            };

            // API Helper
            const callApi = async (action, payload = {}, showLoading = true) => {
                if (!scriptUrl) return;
                if (showLoading) setIsLoading(true);
                try {
                    const response = await fetch(scriptUrl + '?action=' + action, {
                        method: 'POST', 
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (data.status === 'error') throw new Error(data.message);
                    return data;
                } catch (err) {
                    console.error(err);
                    throw err;
                } finally {
                    if (showLoading) setIsLoading(false);
                }
            };

            const refreshData = async () => {
                try {
                    const data = await callApi('read', {}, false);
                    if (data) {
                        const fetchedSlots = normalizeData(data.slots || []);
                        setSlots(fetchedSlots);
                        setRequests(normalizeData(data.requests || []));
                        
                        // Auto-collapse
                        const slotGroups = groupSlotsByMonth(fetchedSlots);
                        const today = new Date();
                        const currentMonthKey = `${today.getFullYear()}å¹´ ${today.getMonth() + 1}æœˆ`;
                        const newCollapsed = {};
                        slotGroups.forEach(g => {
                             if (g.month !== currentMonthKey) newCollapsed[g.month] = true;
                        });
                        setCollapsedMonths(newCollapsed);
                        setHistoryCollapsedMonths(newCollapsed);

                        setError('');
                    }
                } catch (e) { console.error("Refresh failed:", e); }
            };

            useEffect(() => {
                if (scriptUrl) {
                    setIsLoading(true);
                    callApi('read', {}, false).then(data => {
                        if(data) {
                            const fetchedSlots = normalizeData(data.slots || []);
                            setSlots(fetchedSlots);
                            setRequests(normalizeData(data.requests || []));
                            
                            const slotGroups = groupSlotsByMonth(fetchedSlots);
                            const today = new Date();
                            const currentMonthKey = `${today.getFullYear()}å¹´ ${today.getMonth() + 1}æœˆ`;
                            const newCollapsed = {};
                            slotGroups.forEach(g => {
                                if (g.month !== currentMonthKey) newCollapsed[g.month] = true;
                            });
                            setCollapsedMonths(newCollapsed);
                            setHistoryCollapsedMonths(newCollapsed);
                        }
                        setIsLoading(false);
                    }).catch(e => {
                        setError('é€£ç·šå¤±æ•—: ' + e.message);
                        setIsLoading(false);
                    });
                }
            }, [scriptUrl]);

            const handleSaveUrl = () => {
                if(!urlInput.includes('script.google.com')) { alert('ç¶²å€æ ¼å¼çœ‹èµ·ä¾†ä¸å°å–”'); return; }
                localStorage.setItem('minister_gs_url', urlInput);
                setScriptUrl(urlInput);
                setShowSettings(false);
            };

            // --- Logic Helpers ---
            const getDatesInRange = (start, end) => {
                const arr = [];
                const dt = new Date(start);
                const endDate = new Date(end);
                while (dt <= endDate) {
                    arr.push(new Date(dt).toLocaleDateString('sv-SE', { timeZone: 'Asia/Taipei' }));
                    dt.setDate(dt.getDate() + 1);
                }
                return arr;
            };

            const groupSlotsByMonth = (slotsList) => {
                const groups = {};
                slotsList.forEach(slot => {
                    const d = new Date(slot.date);
                    if (isNaN(d.getTime())) return;
                    const key = `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(slot);
                });
                
                return Object.keys(groups).sort((a, b) => {
                    const [y1, m1] = a.replace('å¹´ ', '-').replace('æœˆ', '').split('-');
                    const [y2, m2] = b.replace('å¹´ ', '-').replace('æœˆ', '').split('-');
                    return new Date(y1, m1 - 1) - new Date(y2, m2 - 1);
                }).map(key => ({
                    month: key,
                    items: groups[key].sort((a, b) => {
                        const dateDiff = a.date.localeCompare(b.date);
                        if(dateDiff !== 0) return dateDiff;
                        return a.startTime.localeCompare(b.startTime);
                    })
                }));
            };

            const groupRequestsByMonth = (reqList) => {
                 const groups = {};
                 reqList.forEach(req => {
                     const slot = slots.find(s => s.id == req.slotId);
                     if(!slot) return;
                     const d = new Date(slot.date);
                     if (isNaN(d.getTime())) return;
                     const key = `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
                     if (!groups[key]) groups[key] = [];
                     groups[key].push(req);
                 });
                 
                 return Object.keys(groups).sort((a, b) => {
                    const [y1, m1] = a.replace('å¹´ ', '-').replace('æœˆ', '').split('-');
                    const [y2, m2] = b.replace('å¹´ ', '-').replace('æœˆ', '').split('-');
                    return new Date(y2, m2 - 1) - new Date(y1, m1 - 1); 
                }).map(key => ({
                    month: key,
                    items: groups[key].sort((a, b) => {
                        const slotA = slots.find(s => s.id == a.slotId);
                        const slotB = slots.find(s => s.id == b.slotId);
                        if(!slotA || !slotB) return 0;
                        const dateA = slotA.date + (a.startTime || slotA.startTime);
                        const dateB = slotB.date + (b.startTime || slotB.startTime);
                        return dateA.localeCompare(dateB);
                    })
                }));
            };

            const toggleMonthCollapse = (month) => {
                setCollapsedMonths(prev => ({ ...prev, [month]: !prev[month] }));
            };
            
            const toggleHistoryMonthCollapse = (month) => {
                setHistoryCollapsedMonths(prev => ({ ...prev, [month]: !prev[month] }));
            };

            // --- Handlers ---

            const handleSaveSlot = async (e) => {
                e.preventDefault();
                const originalSlots = [...slots];
                if (editingSlotId) {
                    const updatedSlot = { 
                        ...newSlot, 
                        id: editingSlotId,
                        date: newSlot.startDate 
                    };
                    
                    setSlots(prev => prev.map(s => s.id === editingSlotId ? updatedSlot : s));
                    setNewSlot({ startDate: '', endDate: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' });
                    setEditingSlotId(null);
                    setShowAddSlot(false);

                    try {
                        await callApi('updateSlot', updatedSlot, false);
                    } catch (err) {
                        alert("ä¿®æ”¹å¤±æ•—: " + err.message);
                        setSlots(originalSlots);
                    }
                } else {
                    const dates = getDatesInRange(newSlot.startDate, newSlot.endDate || newSlot.startDate);
                    const newSlotsData = dates.map(d => ({
                        date: d,
                        startTime: newSlot.startTime,
                        endTime: newSlot.endTime,
                        note: newSlot.note,
                        type: newSlot.type,
                        id: Date.now() + Math.random()
                    }));
                    setSlots(prev => [...prev, ...newSlotsData]);
                    setNewSlot({ startDate: '', endDate: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' });
                    setShowAddSlot(false);
                    try {
                        for (const slotData of newSlotsData) { await callApi('addSlot', slotData, false); }
                    } catch (err) {
                        alert("éƒ¨åˆ†æ–°å¢å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¢ºèª");
                        refreshData();
                    }
                }
            };

            const handleEditSlot = (slot) => {
                setEditingSlotId(slot.id);
                setNewSlot({
                    startDate: slot.date,
                    endDate: slot.date, 
                    startTime: slot.startTime,
                    endTime: slot.endTime,
                    note: slot.note,
                    type: slot.type
                });
                setShowAddSlot(true);
            };

            const handleDeleteSlot = async (id) => {
                if (!id) return;
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ™‚æ®µï¼Ÿå°‡ä¸€ä½µåˆªé™¤è©²æ™‚æ®µä¸‹æ‰€æœ‰æœƒè­°ã€‚')) return;
                const originalSlots = [...slots];
                const originalRequests = [...requests];
                setSlots(prev => prev.filter(s => s.id !== id));
                setRequests(prev => prev.filter(r => r.slotId !== id));
                try { await callApi('deleteSlot', { id }, false); }
                catch (err) { alert("åˆªé™¤å¤±æ•—: " + err.message); setSlots(originalSlots); setRequests(originalRequests); }
            };

            const findOverlappingRequest = (slotId, start, end) => {
                 const existingRequests = requests.filter(r => r.slotId == slotId); 
                 return existingRequests.find(req => start < req.endTime && end > req.startTime);
            };

            const handleAddRequest = async (e) => {
                e.preventDefault();
                const conflict = findOverlappingRequest(newRequest.slotId, newRequest.startTime, newRequest.endTime);
                if (conflict) {
                    const statusText = conflict.step === 4 ? "å·²æ­¸æª”" : "é€²è¡Œä¸­";
                    alert(`ç„¡æ³•æ–°å¢ï¼šæ­¤æ™‚æ®µèˆ‡ã€${conflict.title} (${statusText})ã€‘(${conflict.startTime}-${conflict.endTime}) æ™‚é–“é‡ç–Šï¼`);
                    return;
                }
                const tempId = Date.now();
                const reqData = { ...newRequest, id: tempId, slotId: parseInt(newRequest.slotId), step: 1, updatedAt: new Date().toISOString() };
                setRequests(prev => [...prev, reqData]);
                setNewRequest({ title: '', slotId: '', requestorNote: '', requestorName: 'ä¾ç²', startTime: '', endTime: '' });
                setShowAddRequest(false);
                setActiveTab('dashboard');
                try { await callApi('addRequest', reqData, false); }
                catch(err) { alert("æ–°å¢å¤±æ•—: " + err.message); setRequests(prev => prev.filter(r => r.id !== tempId)); }
            };

            const handleUpdateStep = async (reqId, newStep) => {
                const originalRequests = [...requests];
                setRequests(prev => prev.map(r => r.id === reqId ? { ...r, step: newStep, updatedAt: new Date().toISOString() } : r));
                try { await callApi('updateRequestStep', { id: reqId, step: newStep, updatedAt: new Date().toISOString() }, false); }
                catch (err) { console.error("Update step failed", err); setRequests(originalRequests); }
            };

            const handleDeleteRequest = async (id) => {
                if (!confirm('ç¢ºå®šå–æ¶ˆæ­¤æœƒè­°å®‰æ’ï¼Ÿ')) return;
                const originalRequests = [...requests];
                setRequests(prev => prev.filter(r => r.id !== id));
                try { await callApi('deleteRequest', { id }, false); }
                catch (err) { alert("åˆªé™¤å¤±æ•—: " + err.message); setRequests(originalRequests); }
            };

            const toggleFullDay = () => {
                if (newSlot.startTime === '00:00' && newSlot.endTime === '23:45') {
                    setNewSlot({ ...newSlot, startTime: '09:00', endTime: '10:00' });
                } else {
                    setNewSlot({ ...newSlot, startTime: '00:00', endTime: '23:45' });
                }
            };

            if (!scriptUrl || showSettings) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-sky-50">
                        <div className="magic-card p-8 rounded-[40px] shadow-xl max-w-md w-full border-4 border-white/50 relative overflow-hidden">
                            <div className="absolute -top-10 -right-10 text-yellow-300 opacity-30 animate-spin" style={{animationDuration: '10s'}}><Icons.Castle size={200} /></div>
                            <h1 className="text-3xl font-bold mb-4 text-center text-sky-600 tracking-wide relative z-10 flex flex-col items-center gap-2">
                                <Icons.Castle size={60} className="text-pink-400 drop-shadow-sm mb-2" />
                                é­”æ³•æ›¸è¨­å®š
                            </h1>
                            <p className="text-sm text-slate-500 mb-6 text-center font-bold relative z-10">è«‹è²¼ä¸Šæ‚¨çš„ Google Apps Script å’’èªç¶²å€</p>
                            <input type="text" placeholder="https://script.google.com/..." className="w-full p-4 border-2 border-sky-100 rounded-3xl mb-6 focus:border-pink-300 focus:ring focus:ring-pink-100 outline-none transition-all bg-sky-50/50 relative z-10" value={urlInput} onChange={e => setUrlInput(e.target.value)} />
                            <button onClick={handleSaveUrl} className="magic-btn w-full bg-gradient-to-r from-sky-400 to-pink-400 text-white p-4 rounded-full font-bold shadow-lg shadow-pink-200/50 text-lg relative z-10">é–‹å•Ÿé­”æ³•æ›¸ âœ¨</button>
                            {scriptUrl && <button onClick={() => setShowSettings(false)} className="w-full mt-4 text-slate-400 text-sm font-bold relative z-10">å–æ¶ˆ</button>}
                        </div>
                    </div>
                );
            }

            const STEPS = {
                1: { label: 'å¾…ç¢ºèª', color: 'bg-amber-100 text-amber-700 border-amber-200', icon: <Icons.User size={14}/> },
                2: { label: 'å›å ±ä¼Šå›', color: 'bg-sky-100 text-sky-700 border-sky-200', icon: <Icons.Clock size={14}/> },
                3: { label: 'ç¢ºèªä¸­', color: 'bg-purple-100 text-purple-700 border-purple-200', icon: <Icons.AlertCircle size={14}/> },
                4: { label: 'å·²å®Œæˆ', color: 'bg-rose-100 text-rose-700 border-rose-200', icon: <Icons.CheckCircle size={14}/> },
            };
            const WEEKDAYS = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const WEEKDAYS_SIMPLE = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];
            const HOURS = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
            const MINUTES = ['00', '15', '30', '45'];
            
            const TimeSelect = ({ value, onChange, className }) => {
                const [h, m] = value ? value.split(':') : ['09', '00'];
                return (<div className={`flex items-center gap-1 ${className}`}>
                    <select value={h} onChange={(e) => onChange(`${e.target.value}:${m}`)} className="p-3 border-2 border-sky-100 rounded-2xl bg-white flex-1 min-w-[70px] outline-none focus:border-pink-300 font-bold text-slate-600">{HOURS.map(x=><option key={x} value={x}>{x}</option>)}</select>
                    <span className="text-pink-300 font-bold">:</span>
                    <select value={m} onChange={(e) => onChange(`${h}:${e.target.value}`)} className="p-3 border-2 border-sky-100 rounded-2xl bg-white flex-1 min-w-[70px] outline-none focus:border-pink-300 font-bold text-slate-600">{MINUTES.map(x=><option key={x} value={x}>{x}</option>)}</select>
                </div>);
            };
            const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
            const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
            const getSlotDisplay = (id) => { const s = slots.find(x => x.id == id); return s ? `${s.date} ${s.startTime}-${s.endTime}` : 'æœªçŸ¥'; };
            const getRequestsBySlotId = (id) => requests.filter(r => r.slotId == id);
            
            // Allow selecting slots even if they have completed requests (so we can add more meetings to remaining time)
            const getAvailableSlots = () => slots.filter(s => s.type === 'available');

            const groupedSlots = groupSlotsByMonth(slots);
            
            const activeRequests = requests.filter(r => r.step < 4).sort((a, b) => {
                const slotA = slots.find(s => s.id == a.slotId);
                const slotB = slots.find(s => s.id == b.slotId);
                if (!slotA || !slotB) return 0;
                const dateA = slotA.date + (a.startTime || slotA.startTime);
                const dateB = slotB.date + (b.startTime || slotB.startTime);
                return dateA.localeCompare(dateB);
            });
            
            const completedRequests = requests.filter(r => r.step === 4);
            const groupedHistory = groupRequestsByMonth(completedRequests);

            return (
                <div className="min-h-screen flex flex-col max-w-5xl mx-auto shadow-2xl rounded-none sm:rounded-[40px] my-0 sm:my-8 overflow-hidden bg-white/80 backdrop-blur border-4 border-white">
                    <header className="bg-gradient-to-r from-pink-400 via-purple-400 to-sky-400 text-white p-6 sticky top-0 z-20 flex flex-col sm:flex-row justify-between items-center shadow-lg shadow-purple-100">
                        <div className="mb-4 sm:mb-0">
                            <h1 className="text-2xl font-extrabold flex items-center gap-3 tracking-wider drop-shadow-md">
                                <span className="bg-white/20 p-2 rounded-2xl"><Icons.Castle size={28} className="animate-float" /></span> 
                                éƒ¨é•·è¡Œç¨‹é­”æ³•æ›¸
                            </h1>
                        </div>
                        <div className="flex items-center gap-3">
                            {isLoading && <div className="animate-wand text-yellow-200"><Icons.Wand size={28}/></div>}
                            <button onClick={() => refreshData()} className="magic-btn text-xs bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full text-white font-bold backdrop-blur-md border border-white/30">é‡æ–°æ•´ç† â†»</button>
                            <button onClick={() => setShowSettings(true)} className="magic-btn text-white/80 hover:text-white bg-white/10 p-2 rounded-full"><Icons.Settings size={22}/></button>
                            <button onClick={() => { setEditingSlotId(null); setNewSlot({ startDate: '', endDate: '', startTime: '09:00', endTime: '10:00', note: '', type: 'available' }); setShowAddSlot(true); }} className="magic-btn bg-white text-pink-500 px-5 py-2.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-lg shadow-pink-500/20 hover:bg-pink-50">
                                <Icons.Plus size={18} /> <span className="hidden sm:inline">è¨˜æ™‚æ®µ</span>
                            </button>
                        </div>
                    </header>
                    
                    {error && <div className="bg-rose-100 border-l-8 border-rose-400 text-rose-600 p-4 m-6 rounded-r-xl shadow-sm font-bold" role="alert"><p>{error}</p></div>}

                    <div className="p-4 sm:p-6 flex-1 bg-white/50">
                        <div className="flex gap-3 mb-6 overflow-x-auto p-1">
                            {['calendar', 'dashboard', 'slots'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`magic-btn px-6 py-3 font-bold flex items-center gap-2 whitespace-nowrap transition-all rounded-full shadow-sm border-2 ${activeTab === tab ? 'bg-sky-100 text-sky-600 border-sky-200' : 'bg-white text-slate-400 border-transparent hover:bg-slate-50'}`}>
                                    {tab === 'calendar' && <><Icons.Calendar size={18}/> æœˆæ›†</>}
                                    {tab === 'dashboard' && <><Icons.List size={18}/> è¿½è¹¤</>}
                                    {tab === 'slots' && <><Icons.Clock size={18}/> åˆ—è¡¨</>}
                                </button>
                            ))}
                        </div>

                        {/* Modals */}
                        {showAddSlot && (
                            <div className="fixed inset-0 bg-sky-900/30 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
                                <div className="magic-card p-8 rounded-[40px] shadow-2xl max-w-md w-full animate-fade-in-down my-8">
                                    <h3 className="font-bold text-2xl mb-6 flex items-center gap-3 text-slate-700">
                                        <span className="bg-sky-100 p-2 rounded-full text-sky-500"><Icons.Plus size={24}/></span> {editingSlotId ? 'ä¿®æ”¹æ™‚æ®µ' : 'æ–°å¢æ™‚æ®µ'}
                                    </h3>
                                    <form onSubmit={handleSaveSlot} className="space-y-5">
                                        <div className="flex gap-3 p-1 bg-slate-100 rounded-full">
                                            <button type="button" onClick={() => setNewSlot({...newSlot, type: 'available'})} className={`flex-1 py-3 rounded-full font-bold flex gap-2 justify-center transition-all ${newSlot.type === 'available' ? 'bg-white text-emerald-500 shadow-md' : 'text-slate-400'}`}><Icons.CheckCircle size={18}/> æœ‰ç©º</button>
                                            <button type="button" onClick={() => setNewSlot({...newSlot, type: 'occupied'})} className={`flex-1 py-3 rounded-full font-bold flex gap-2 justify-center transition-all ${newSlot.type === 'occupied' ? 'bg-white text-rose-500 shadow-md' : 'text-slate-400'}`}><Icons.Ban size={18}/> æ»¿æª”</button>
                                        </div>
                                        
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <div className="flex-1">
                                                <label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">é–‹å§‹æ—¥æœŸ</label>
                                                <input type="date" required className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" 
                                                    value={newSlot.startDate} 
                                                    onChange={e => setNewSlot({...newSlot, startDate: e.target.value, endDate: newSlot.endDate || e.target.value})}
                                                />
                                            </div>
                                            {!editingSlotId && (
                                                <div className="flex-1">
                                                    <label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">çµæŸæ—¥æœŸ</label>
                                                    <input type="date" required className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" 
                                                        value={newSlot.endDate} 
                                                        onChange={e => setNewSlot({...newSlot, endDate: e.target.value})}
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        <div className="p-4 bg-slate-50 rounded-3xl border border-slate-100 space-y-3">
                                            <label className="text-xs font-bold text-slate-400 uppercase block tracking-wider">æ™‚é–“è¨­å®š</label>
                                            <div className="flex flex-col gap-3">
                                                <div className="flex gap-2 items-center w-full">
                                                    <div className="flex-1"><TimeSelect value={newSlot.startTime} onChange={v => setNewSlot({...newSlot, startTime: v})} /></div>
                                                    <span className="text-slate-300 font-bold">-</span>
                                                    <div className="flex-1"><TimeSelect value={newSlot.endTime} onChange={v => setNewSlot({...newSlot, endTime: v})} /></div>
                                                </div>
                                                <button type="button" onClick={toggleFullDay} className={`w-full px-4 py-3 rounded-2xl text-sm font-bold transition-all border-2 flex items-center justify-center gap-2 ${newSlot.startTime === '00:00' && newSlot.endTime === '23:45' ? 'bg-purple-100 text-purple-600 border-purple-200' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'}`}>
                                                    <Icons.Star size={16}/> {newSlot.startTime === '00:00' && newSlot.endTime === '23:45' ? 'âœ¨ å…¨å¤©æ™‚æ®µ' : 'è¨­ç‚ºå…¨å¤©'}
                                                </button>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">{newSlot.type === 'occupied' ? 'äº‹é …èªªæ˜' : 'å‚™è¨»'}</label>
                                            <input type="text" className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" value={newSlot.note} onChange={e => setNewSlot({...newSlot, note: e.target.value})} placeholder={newSlot.type === 'occupied' ? "ä¾‹å¦‚ï¼šè¡Œæ”¿é™¢æœƒ" : "ä¾‹å¦‚ï¼šéƒ¨é•·åœ¨è¾¦å…¬å®¤"}/>
                                        </div>
                                        <div className="flex gap-3 pt-2"><button type="button" onClick={() => setShowAddSlot(false)} className="magic-btn flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold">å–æ¶ˆ</button><button type="submit" disabled={isLoading} className="magic-btn flex-1 py-3 bg-gradient-to-r from-emerald-400 to-teal-400 text-white rounded-2xl font-bold shadow-lg shadow-emerald-200">{isLoading?'å„²å­˜ä¸­...':'å„²å­˜'}</button></div>
                                    </form>
                                </div>
                            </div>
                        )}
                        
                        {showAddRequest && (
                            <div className="fixed inset-0 bg-sky-900/30 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
                                <div className="magic-card p-8 rounded-[40px] shadow-2xl max-w-md w-full animate-fade-in-down my-8">
                                    <h3 className="font-bold text-2xl mb-6 text-slate-700">æ–°å¢æœƒè­°å®‰æ’</h3>
                                    <form onSubmit={handleAddRequest} className="space-y-5">
                                        <div><label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">é¸æ“‡ç©ºæª”</label><select className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" value={newRequest.slotId} onChange={e=>{const s=slots.find(x=>x.id==e.target.value); if(s) setNewRequest({...newRequest, slotId: s.id, startTime:s.startTime, endTime:s.endTime});}} required><option value="">è«‹é¸æ“‡ä¸€å€‹ç©ºæª”</option>{getAvailableSlots().map(s=><option key={s.id} value={s.id}>{s.date} {s.startTime}-{s.endTime}</option>)}</select></div>
                                        {newRequest.slotId && <div className="p-4 bg-sky-50 rounded-3xl border-2 border-sky-100"><label className="text-xs font-bold text-sky-400 uppercase mb-2 block tracking-wider">æœƒè­°æ™‚é–“</label><div className="flex gap-2 items-center"><TimeSelect value={newRequest.startTime} onChange={v=>setNewRequest({...newRequest, startTime:v})} className="flex-1"/><span className="text-sky-300 font-bold">-</span><TimeSelect value={newRequest.endTime} onChange={v=>setNewRequest({...newRequest, endTime:v})} className="flex-1"/></div></div>}
                                        <div><label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">é ç´„äºº</label><input type="text" className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" value={newRequest.requestorName} onChange={e => setNewRequest({...newRequest, requestorName: e.target.value})} required/></div>
                                        <div><label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">äº‹é …</label><input type="text" className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" value={newRequest.title} onChange={e => setNewRequest({...newRequest, title: e.target.value})} required/></div>
                                        <div><label className="text-sm font-bold text-slate-500 ml-2 mb-1 block">å‚™è¨»</label><input type="text" className="w-full p-3 border-2 border-sky-100 rounded-2xl bg-sky-50/30 outline-none focus:border-pink-300 font-bold text-slate-700" value={newRequest.requestorNote} onChange={e => setNewRequest({...newRequest, requestorNote: e.target.value})}/></div>
                                        <div className="flex gap-3 pt-2"><button type="button" onClick={() => setShowAddRequest(false)} className="magic-btn flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold">å–æ¶ˆ</button><button type="submit" disabled={isLoading} className="magic-btn flex-1 py-3 bg-gradient-to-r from-sky-400 to-blue-500 text-white rounded-2xl font-bold shadow-lg shadow-sky-200">{isLoading?'è™•ç†ä¸­...':'å»ºç«‹'}</button></div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="magic-card rounded-[32px] overflow-hidden shadow-lg shadow-purple-100/50">
                                <div className="flex justify-between items-center p-6 bg-gradient-to-r from-purple-50 to-pink-50 border-b-2 border-white">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="magic-btn p-3 bg-white rounded-full text-purple-400 shadow-sm hover:text-purple-600"><Icons.ChevronLeft size={24}/></button>
                                    <h2 className="text-2xl font-extrabold text-slate-600 tracking-wider">{currentDate.getFullYear()}å¹´ <span className="text-purple-500">{currentDate.getMonth() + 1}æœˆ</span></h2>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="magic-btn p-3 bg-white rounded-full text-purple-400 shadow-sm hover:text-purple-600"><Icons.ChevronRight size={24}/></button>
                                </div>
                                <div className="grid grid-cols-7 border-b border-purple-50 bg-white/50">{WEEKDAYS.map(d => <div key={d} className="py-4 text-center text-sm font-bold text-slate-400">{d}</div>)}</div>
                                <div className="grid grid-cols-7 auto-rows-fr bg-white/80">
                                    {Array.from({ length: getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`e-${i}`} className="min-h-[120px] border-b border-r border-purple-50 bg-slate-50/30"></div>)}
                                    {Array.from({ length: getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => {
                                        const day = i + 1;
                                        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                        const isToday = new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                                        const daySlots = slots.filter(s => s.date === dateStr).sort((a,b) => a.startTime.localeCompare(b.startTime));
                                        const holiday = getHolidayName(dateStr);

                                        return (
                                            <div key={day} className={`min-h-[120px] border-b border-r border-purple-50 p-2 relative hover:bg-sky-50 transition-colors group ${isToday ? 'bg-pink-50/50' : ''}`}>
                                                <div className="flex justify-between mb-2 items-start">
                                                    <div className="flex flex-col items-center">
                                                        <span className={`text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full ${isToday?'bg-gradient-to-tr from-pink-400 to-rose-400 text-white shadow-md shadow-pink-200': holiday ? 'text-rose-500' : 'text-slate-600'}`}>{day}</span>
                                                        {holiday && <span className="text-[10px] font-bold text-rose-500 bg-rose-50 px-1 rounded mt-0.5">{holiday}</span>}
                                                    </div>
                                                    {daySlots.length===0 && <button onClick={()=>{setNewSlot({...newSlot, startDate: dateStr, endDate: dateStr}); setShowAddSlot(true);}} className="hidden group-hover:flex w-8 h-8 items-center justify-center text-emerald-400 bg-emerald-50 rounded-full hover:bg-emerald-100 transition-all"><Icons.Plus size={18}/></button>}
                                                </div>
                                                <div className="space-y-1.5">
                                                    {daySlots.map(slot => {
                                                        const reqs = getRequestsBySlotId(slot.id).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                                        if(slot.type === 'occupied') return <div key={slot.id} className="text-[11px] p-2 bg-slate-100 text-slate-500 rounded-xl border border-slate-200 flex flex-wrap gap-1 font-bold tabular-nums"><div className="flex items-center gap-1 w-full"><Icons.Ban size={12}/> {slot.startTime}-{slot.endTime}</div><div className="truncate w-full font-normal opacity-80">{slot.note}</div></div>;
                                                        return (
                                                            <div key={slot.id} onClick={()=>{setNewRequest({...newRequest, slotId: slot.id, startTime: slot.startTime, endTime: slot.endTime}); setShowAddRequest(true);}} className="text-[11px] p-2 bg-emerald-50 border border-emerald-100 rounded-xl cursor-pointer hover:bg-emerald-100 hover:scale-[1.02] transition-transform shadow-sm">
                                                                <div className="font-bold text-emerald-600 flex justify-between tabular-nums"><span>{slot.startTime}-{slot.endTime}</span>{reqs.length===0 && <span className="w-2 h-2 rounded-full bg-emerald-400"></span>}</div>
                                                                {reqs.map(r => <div key={r.id} onClick={(e)=>{e.stopPropagation(); setActiveTab('dashboard');}} className={`mt-1.5 p-1.5 rounded-lg border flex gap-1 items-start ${r.step===4?'bg-gradient-to-r from-emerald-400 to-teal-400 text-white border-transparent shadow-sm':'bg-white text-sky-700 border-sky-100'}`}>{r.step===4?<Icons.CheckCircle size={12}/>:<Icons.CornerDownRight size={12}/>}<div className="truncate leading-tight font-bold">{r.title}</div></div>)}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-center mb-4 bg-white p-1 rounded-full shadow-sm border-2 border-sky-100 w-fit mx-auto">
                                    <button 
                                        onClick={() => setDashboardTab('active')} 
                                        className={`px-6 py-2 rounded-full font-bold text-sm transition-all flex items-center gap-2 ${dashboardTab === 'active' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}
                                    >
                                        <Icons.Fire size={16}/> é€²è¡Œä¸­
                                    </button>
                                    <button 
                                        onClick={() => setDashboardTab('completed')} 
                                        className={`px-6 py-2 rounded-full font-bold text-sm transition-all flex items-center gap-2 ${dashboardTab === 'completed' ? 'bg-emerald-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}
                                    >
                                        <Icons.Archive size={16}/> æ­·å²æ­¸æª”
                                    </button>
                                </div>

                                <div className="flex justify-between items-center bg-white p-5 rounded-[24px] border-2 border-sky-100 shadow-sm">
                                    <div><h2 className="font-bold text-sky-800 text-lg">{dashboardTab === 'active' ? 'å¾…è¾¦æœƒè­°çœ‹æ¿' : 'å·²å®Œæˆæ­·å²ç´€éŒ„'}</h2></div>
                                    <button onClick={() => setShowAddRequest(true)} className="magic-btn bg-sky-500 text-white px-5 py-2.5 rounded-full text-sm font-bold flex gap-2 shadow-lg shadow-sky-200"><Icons.Plus size={18}/> æ–°å¢</button>
                                </div>

                                {dashboardTab === 'active' && (
                                    <div className="grid gap-4">
                                        {activeRequests.map(req => {
                                            const slotDate = getSlotDisplay(req.slotId).split(' ')[0];
                                            return (
                                                <div key={req.id} className="bg-white rounded-[24px] shadow-sm border-2 border-white p-5 relative overflow-hidden transition-all hover:shadow-md">
                                                    <div className={`absolute left-0 top-0 bottom-0 w-2 ${STEPS[req.step].color.split(' ')[0]}`}></div>
                                                    <div className="pl-4 flex flex-col sm:flex-row justify-between gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className={`text-[11px] px-3 py-1 rounded-full border font-bold flex items-center gap-1.5 ${STEPS[req.step].color}`}>{STEPS[req.step].icon} {STEPS[req.step].label}</span>
                                                                <span className="text-xs text-slate-400 font-bold tabular-nums">{new Date(req.updatedAt).toLocaleDateString()}</span>
                                                            </div>
                                                            <h3 className="font-extrabold text-lg mb-2 text-slate-700">{req.title}</h3>
                                                            <div className="text-sm text-slate-500 flex flex-wrap items-center gap-4 bg-slate-50 p-2 rounded-xl inline-flex mb-2">
                                                                <span className="flex items-center gap-1"><Icons.User size={14} className="text-pink-400"/> <b>{req.requestorName}</b></span>
                                                                <span className="text-slate-300">|</span>
                                                                <span className="flex items-center gap-1 tabular-nums"><Icons.Calendar size={14} className="text-sky-400"/> <b>{slotDate} {WEEKDAYS_SIMPLE[new Date(slotDate).getUTCDay()]} {req.startTime}-{req.endTime}</b></span>
                                                            </div>
                                                            {req.requestorNote && <div className="text-xs text-slate-500 mt-2 bg-slate-50 p-2 rounded-lg border border-slate-100 flex gap-2"><span className="font-bold text-slate-400">å‚™è¨»:</span> {req.requestorNote}</div>}
                                                        </div>
                                                        <div className="flex items-end gap-2">
                                                            {req.step<4 && <button onClick={()=>handleUpdateStep(req.id, req.step+1)} disabled={isLoading} className="magic-btn bg-slate-800 text-white text-xs px-4 py-2 rounded-full flex items-center gap-1.5 font-bold shadow-lg shadow-slate-300/50 hover:bg-slate-700">ä¸‹ä¸€æ­¥ <Icons.ArrowRight size={12}/></button>}
                                                            {req.step>1 && <button onClick={()=>handleUpdateStep(req.id, req.step-1)} disabled={isLoading} className="text-slate-400 hover:text-slate-600 text-xs px-3 font-bold underline">è¿”å›</button>}
                                                            <button onClick={()=>handleDeleteRequest(req.id)} disabled={isLoading} className="magic-btn text-rose-300 hover:text-rose-500 p-2 bg-rose-50 rounded-full ml-2"><Icons.Trash2 size={18}/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {activeRequests.length===0 && <div className="text-center py-12 text-slate-400 border-2 border-dashed border-sky-200 bg-white/50 rounded-[30px] font-bold flex flex-col items-center gap-2"><Icons.Carriage size={48} className="text-sky-200 mb-2"/>æ²’æœ‰å¾…è¾¦äº‹é …ï¼Œå¯ä»¥ä¼‘æ¯ä¸€ä¸‹ âœ¨</div>}
                                    </div>
                                )}

                                {dashboardTab === 'completed' && (
                                    <div className="space-y-6">
                                        {groupedHistory.map(group => (
                                            <div key={group.month} className="magic-card rounded-[32px] overflow-hidden shadow-lg shadow-emerald-50/50 transition-all">
                                                <div 
                                                    className="bg-gradient-to-r from-emerald-50 to-white p-4 px-6 flex justify-between items-center cursor-pointer hover:bg-emerald-100 transition-colors sticky-group-header"
                                                    onClick={() => toggleHistoryMonthCollapse(group.month)}
                                                >
                                                    <h3 className="font-extrabold text-emerald-800 text-lg flex items-center gap-2"><Icons.Calendar size={20}/> {group.month}</h3>
                                                    <div className="text-emerald-400">{historyCollapsedMonths[group.month] ? <Icons.ChevronDown size={20}/> : <Icons.ChevronUp size={20}/>}</div>
                                                </div>
                                                {!historyCollapsedMonths[group.month] && (
                                                    <div className="p-4 grid gap-3 bg-white/50">
                                                        {group.items.map(req => {
                                                            const slotDate = getSlotDisplay(req.slotId).split(' ')[0];
                                                            return (
                                                                <div key={req.id} className="bg-white border border-emerald-100 rounded-2xl p-4 flex items-center gap-4 shadow-sm hover:shadow-md transition-all group">
                                                                    <div className="flex flex-col items-center justify-center bg-emerald-50 rounded-xl p-2 min-w-[100px] border border-emerald-100">
                                                                        <span className="text-xs font-bold text-emerald-800 tabular-nums tracking-wide">{slotDate}</span>
                                                                        <span className="text-[10px] font-bold text-emerald-500 my-0.5">{WEEKDAYS_SIMPLE[new Date(slotDate).getUTCDay()]}</span>
                                                                        <span className="text-xs font-bold text-emerald-700 tabular-nums">{req.startTime}-{req.endTime}</span>
                                                                    </div>
                                                                    <div className="flex-1 min-w-0 py-1">
                                                                        <h4 className="font-bold text-slate-700 text-lg truncate">{req.title}</h4>
                                                                        <div className="flex items-center gap-4 mt-1 text-xs text-slate-500">
                                                                            <span className="flex items-center gap-1"><Icons.User size={12} className="text-emerald-300"/> {req.requestorName}</span>
                                                                            {req.requestorNote && <span className="truncate border-l-2 border-slate-100 pl-2 text-slate-400">{req.requestorNote}</span>}
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="hidden sm:flex bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold items-center gap-1"><Icons.CheckCircle size={12}/> å®Œæˆ</div>
                                                                        <button onClick={()=>handleDeleteRequest(req.id)} className="text-slate-300 hover:text-rose-500 p-2 rounded-full hover:bg-rose-50 transition-colors opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        {groupedHistory.length===0 && <div className="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 bg-white/50 rounded-[30px] font-bold">å°šç„¡æ­·å²ç´€éŒ„</div>}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'slots' && (
                             <div className="space-y-6">
                                {groupedSlots.map(group => (
                                    <div key={group.month} className="magic-card rounded-[32px] overflow-hidden shadow-lg shadow-blue-50/50 transition-all">
                                        <div 
                                            className="bg-gradient-to-r from-sky-100 to-blue-50 p-4 px-6 flex justify-between items-center cursor-pointer hover:bg-sky-200 transition-colors sticky-group-header"
                                            onClick={() => toggleMonthCollapse(group.month)}
                                        >
                                            <h3 className="font-extrabold text-sky-800 text-lg flex items-center gap-2">
                                                <Icons.Calendar size={20}/> {group.month}
                                            </h3>
                                            <div className="text-sky-400">
                                                {collapsedMonths[group.month] ? <Icons.ChevronDown size={20}/> : <Icons.ChevronUp size={20}/>}
                                            </div>
                                        </div>
                                        
                                        {!collapsedMonths[group.month] && (
                                            <table className="w-full text-left text-sm table-fixed">
                                                <thead className="bg-white border-b border-sky-100"><tr><th className="p-5 font-bold text-sky-700 w-[220px]">æ—¥æœŸæ™‚é–“</th><th className="p-5 font-bold text-sky-700 w-auto">å‚™è¨»/äº‹é …</th><th className="p-5 font-bold text-sky-700 w-[100px] text-center">ç‹€æ…‹</th><th className="p-5 text-right font-bold text-sky-700 w-[100px]">æ“ä½œ</th></tr></thead>
                                                <tbody className="divide-y divide-sky-50">
                                                    {group.items.map(slot=>(
                                                        <tr key={slot.id} className="hover:bg-sky-50/50 transition-colors">
                                                            <td className="p-5">
                                                                <div className="flex flex-col gap-1">
                                                                    <div className="flex items-baseline gap-2 pl-2">
                                                                        <span className="font-extrabold text-slate-700 text-base tabular-nums tracking-wide w-[105px]">{slot.date}</span>
                                                                        <span className="text-slate-400 text-sm font-bold">{WEEKDAYS_SIMPLE[new Date(slot.date).getUTCDay()]}</span>
                                                                    </div>
                                                                    <div className="text-sky-600 font-bold text-sm bg-sky-50 px-2 py-1 rounded-lg w-fit tabular-nums ml-1">
                                                                        {slot.startTime} - {slot.endTime}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-5">
                                                                {slot.type === 'occupied' ? <span className="font-bold text-slate-700 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-rose-400"></span> {slot.note}</span> : <span className="text-slate-400 font-medium">{slot.note}</span>}
                                                            </td>
                                                            <td className="p-5 text-center">{slot.type==='occupied'?<span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold border border-slate-200 whitespace-nowrap">æ»¿æª”</span>:<span className="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold border border-emerald-200 whitespace-nowrap">æœ‰ç©º</span>}</td>
                                                            <td className="p-5 text-right">
                                                                <div className="flex gap-2 justify-end">
                                                                    <button onClick={()=>handleEditSlot(slot)} className="text-slate-400 hover:text-sky-500 p-2 rounded-full hover:bg-sky-50 transition-colors">
                                                                        <Icons.Edit size={18}/>
                                                                    </button>
                                                                    <button onClick={()=>handleDeleteSlot(slot.id)} className="text-slate-300 hover:text-rose-500 p-2 rounded-full hover:bg-rose-50 transition-colors">
                                                                        <Icons.Trash2 size={18}/>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                ))}
                                {groupedSlots.length === 0 && <div className="text-center py-12 text-slate-400 border-2 border-dashed border-sky-200 bg-white/50 rounded-[30px] font-bold">ç›®å‰æ²’æœ‰ä»»ä½•æ™‚æ®µè³‡æ–™ âœ¨</div>}
                             </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MinisterScheduleApp />);
    </script>
</body>
</html>
